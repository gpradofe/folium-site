{
  "openapi": "3.1.0",
  "info": {
    "title": "Folium PDF Generation API",
    "version": "1.0.0",
    "description": "REST API for generating PDFs from templates using the Folium rendering engine. Folium renders PDFs in under 100ms using a custom Rust-based layout engine — no headless browsers, no LaTeX, no wkhtmltopdf.\n\n## Authentication\n\nAll protected endpoints require an API key passed via one of:\n- `Authorization: Bearer <your-api-key>` header\n- `X-API-Key: <your-api-key>` header\n\nIn development mode (no `FOLIUM_API_KEYS` configured), authentication is bypassed.\n\n## Rate Limits\n\nRate limits are enforced per API key using a sliding window (default: 60 seconds):\n\n| Tier | Requests/min |\n|------|-------------|\n| Free | 10 |\n| Starter | 60 |\n| Pro | 300 |\n| Enterprise | 1,000 |\n\nRate limit headers are included in every response:\n- `X-RateLimit-Limit` — max requests per window\n- `X-RateLimit-Remaining` — remaining requests\n\n## Error Codes\n\n| Code | HTTP Status | Description |\n|------|-------------|-------------|\n| `INVALID_TEMPLATE` | 400 | Template JSON is malformed or missing required fields |\n| `RENDER_FAILED` | 422 | PDF rendering failed (e.g., invalid layout) |\n| `RENDER_PANICKED` | 500 | Unexpected engine error |\n| `PAYLOAD_TOO_LARGE` | 413 | Request body exceeds maximum size |\n| `TOO_MANY_REQUESTS` | 429 | Concurrent render limit exceeded |\n| `RATE_LIMITED` | 429 | Rate limit exceeded |\n| `RENDER_TIMEOUT` | 504 | Rendering timed out |\n| `UNAUTHORIZED` | 401 | Invalid or missing API key |\n| `USAGE_UNAVAILABLE` | 503 | Usage tracking not enabled |\n| `NOT_FOUND` | 404 | Resource not found |\n| `INTERNAL_ERROR` | 500 | Internal server error |",
    "contact": {
      "name": "API Support",
      "url": "https://docs.folium.cc"
    }
  },
  "servers": [
    {
      "url": "https://api.folium.cc",
      "description": "Production server"
    },
    {
      "url": "http://localhost:8080",
      "description": "Development server"
    }
  ],
  "security": [
    {
      "api_key": []
    }
  ],
  "tags": [
    { "name": "Health", "description": "Service health and status endpoints" },
    { "name": "Info", "description": "API information and versioning" },
    { "name": "Generate", "description": "PDF generation endpoints" },
    { "name": "Usage", "description": "API usage tracking and metrics" }
  ],
  "paths": {
    "/health": {
      "get": {
        "tags": ["Health"],
        "summary": "Health check",
        "description": "Returns the current health status and API version. This endpoint is public and does not require authentication.",
        "operationId": "healthCheck",
        "security": [],
        "responses": {
          "200": {
            "description": "Service is healthy",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/HealthResponse" },
                "example": {
                  "status": "healthy",
                  "version": "1.0.0"
                }
              }
            }
          }
        }
      }
    },
    "/v1/info": {
      "get": {
        "tags": ["Info"],
        "summary": "Get API information",
        "description": "Returns API name, version, underlying engine, and documentation URL. Requires authentication.",
        "operationId": "apiInfo",
        "responses": {
          "200": {
            "description": "API information",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiInfoResponse" },
                "example": {
                  "name": "Folium PDF API",
                  "version": "1.0.0",
                  "engine": "folium-core",
                  "docs_url": "https://docs.folium.cc"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiError" },
                "example": {
                  "error": {
                    "code": "UNAUTHORIZED",
                    "message": "Invalid or missing API key"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/v1/generate": {
      "post": {
        "tags": ["Generate"],
        "summary": "Generate a PDF",
        "description": "Generate a PDF synchronously from a template and data. The template can be provided as a JSON object (`template` field) or a pre-serialized JSON string (`template_json` field). Data is merged into template placeholders using Handlebars syntax (`{{variable}}`).\n\nThe response is the raw PDF binary with `application/pdf` content type.\n\n**Response headers:**\n- `X-Folium-Render-Time-Ms` — rendering time in milliseconds\n- `X-Folium-Size-Bytes` — PDF file size\n- `Content-Disposition` — attachment filename",
        "operationId": "generateSync",
        "requestBody": {
          "required": true,
          "description": "Template and data for PDF generation",
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/GenerateRequest" },
              "examples": {
                "simple": {
                  "summary": "Simple text PDF",
                  "value": {
                    "template": {
                      "name": "hello",
                      "template": {
                        "type": "text",
                        "content": "Hello {{name}}!",
                        "style": { "fontSize": 24 }
                      }
                    },
                    "data": { "name": "World" },
                    "options": { "filename": "hello.pdf" }
                  }
                },
                "invoice": {
                  "summary": "Invoice with multiple elements",
                  "value": {
                    "template": {
                      "name": "simple-invoice",
                      "template": {
                        "type": "container",
                        "children": [
                          {
                            "type": "text",
                            "content": "Invoice #{{invoice_number}}",
                            "style": { "fontSize": 24, "fontWeight": "bold" }
                          },
                          {
                            "type": "text",
                            "content": "Amount: ${{amount}}",
                            "style": { "fontSize": 16 }
                          }
                        ]
                      }
                    },
                    "data": {
                      "invoice_number": "INV-001",
                      "amount": "150.00"
                    },
                    "options": {
                      "filename": "invoice-001.pdf",
                      "compress": true
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "PDF generated successfully",
            "headers": {
              "X-Folium-Render-Time-Ms": {
                "description": "Render time in milliseconds",
                "schema": { "type": "integer" }
              },
              "X-Folium-Size-Bytes": {
                "description": "PDF size in bytes",
                "schema": { "type": "integer" }
              },
              "Content-Disposition": {
                "description": "Attachment filename",
                "schema": { "type": "string" }
              }
            },
            "content": {
              "application/pdf": {
                "schema": { "type": "string", "format": "binary" }
              }
            }
          },
          "400": {
            "description": "Invalid template or request",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiError" },
                "example": {
                  "error": {
                    "code": "INVALID_TEMPLATE",
                    "message": "Template JSON is malformed or missing required fields"
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiError" }
              }
            }
          },
          "422": {
            "description": "Render failed",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiError" },
                "example": {
                  "error": {
                    "code": "RENDER_FAILED",
                    "message": "Layout calculation failed: invalid container dimensions"
                  }
                }
              }
            }
          },
          "429": {
            "description": "Too many requests or rate limited",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiError" },
                "example": {
                  "error": {
                    "code": "RATE_LIMITED",
                    "message": "Rate limit exceeded. Max 60 requests per 60 seconds."
                  }
                }
              }
            }
          },
          "504": {
            "description": "Render timeout",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiError" },
                "example": {
                  "error": {
                    "code": "RENDER_TIMEOUT",
                    "message": "PDF rendering timed out."
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/usage/{api_key}": {
      "get": {
        "tags": ["Usage"],
        "summary": "Get usage metrics",
        "description": "Returns usage statistics for the specified API key, including total requests, PDFs generated, bytes produced, current billing period usage, tier, and rate limit.",
        "operationId": "getUsage",
        "parameters": [
          {
            "name": "api_key",
            "in": "path",
            "required": true,
            "description": "API key to get usage for",
            "schema": { "type": "string" },
            "example": "fp_test_1234567890abcdef"
          }
        ],
        "responses": {
          "200": {
            "description": "Usage metrics retrieved",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/UsageSummary" },
                "example": {
                  "api_key": "fp_test_1234567890abcdef",
                  "total_requests": 1250,
                  "total_pdfs_generated": 1180,
                  "total_bytes": 15728640,
                  "current_period": {
                    "requests": 45,
                    "period_start": "2024-02-10T17:00:00Z"
                  },
                  "tier": "pro",
                  "rate_limit": 300
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiError" }
              }
            }
          },
          "404": {
            "description": "API key not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiError" },
                "example": {
                  "error": {
                    "code": "NOT_FOUND",
                    "message": "No usage data found for API key"
                  }
                }
              }
            }
          },
          "503": {
            "description": "Usage tracking unavailable",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiError" },
                "example": {
                  "error": {
                    "code": "USAGE_UNAVAILABLE",
                    "message": "Usage tracking is not enabled (no DATABASE_URL configured)"
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "api_key": {
        "type": "apiKey",
        "in": "header",
        "name": "Authorization",
        "description": "API key passed as `Bearer <key>` in the Authorization header, or via the `X-API-Key` header."
      }
    },
    "schemas": {
      "HealthResponse": {
        "type": "object",
        "required": ["status", "version"],
        "properties": {
          "status": {
            "type": "string",
            "description": "Service health status",
            "example": "healthy"
          },
          "version": {
            "type": "string",
            "description": "API version",
            "example": "1.0.0"
          }
        }
      },
      "ApiInfoResponse": {
        "type": "object",
        "required": ["name", "version", "engine", "docs_url"],
        "properties": {
          "name": { "type": "string", "example": "Folium PDF API" },
          "version": { "type": "string", "example": "1.0.0" },
          "engine": { "type": "string", "example": "folium-core" },
          "docs_url": { "type": "string", "example": "https://docs.folium.cc" }
        }
      },
      "GenerateRequest": {
        "type": "object",
        "description": "Request body for PDF generation. Provide either `template` (JSON object) or `template_json` (pre-serialized string).",
        "properties": {
          "template": {
            "description": "Full template object with name, template tree, and optional styles.",
            "example": {
              "name": "invoice",
              "template": {
                "type": "container",
                "children": [
                  { "type": "text", "content": "Hello {{name}}!", "style": { "fontSize": 20 } }
                ]
              }
            }
          },
          "template_json": {
            "type": "string",
            "description": "Raw template JSON string (alternative to `template`).",
            "example": "{\"name\":\"simple\",\"template\":{\"type\":\"text\",\"content\":\"Hello World\"}}"
          },
          "data": {
            "type": "object",
            "description": "Data to bind into the template using Handlebars syntax (`{{variable}}`).",
            "example": { "name": "John", "amount": 150.50, "items": ["Item 1", "Item 2"] }
          },
          "options": {
            "$ref": "#/components/schemas/GenerateOptions"
          }
        }
      },
      "GenerateOptions": {
        "type": "object",
        "properties": {
          "filename": {
            "type": "string",
            "description": "Output filename for the PDF (used in Content-Disposition header).",
            "default": "document.pdf",
            "example": "invoice-001.pdf"
          },
          "compress": {
            "type": "boolean",
            "description": "Whether to compress the PDF output. Reserved for future use.",
            "default": true,
            "example": true
          }
        }
      },
      "GenerateMetaResponse": {
        "type": "object",
        "properties": {
          "job_id": { "type": "string", "example": "gen_1234567890" },
          "status": { "type": "string", "example": "completed" },
          "pages": { "type": "integer", "example": 2 },
          "size_bytes": { "type": "integer", "example": 45632 },
          "render_time_ms": { "type": "integer", "example": 156 }
        }
      },
      "UsageSummary": {
        "type": "object",
        "description": "API key usage statistics",
        "properties": {
          "api_key": { "type": "string", "example": "fp_test_1234567890abcdef" },
          "total_requests": { "type": "integer", "example": 1250 },
          "total_pdfs_generated": { "type": "integer", "example": 1180 },
          "total_bytes": { "type": "integer", "example": 15728640 },
          "current_period": { "$ref": "#/components/schemas/PeriodUsage" },
          "tier": { "type": "string", "example": "pro" },
          "rate_limit": { "type": "integer", "example": 300 }
        }
      },
      "PeriodUsage": {
        "type": "object",
        "description": "Current period usage for rate limiting",
        "properties": {
          "requests": { "type": "integer", "example": 45 },
          "period_start": { "type": "string", "format": "date-time", "example": "2024-02-10T17:00:00Z" }
        }
      },
      "ApiError": {
        "type": "object",
        "description": "Error response wrapper",
        "properties": {
          "error": { "$ref": "#/components/schemas/ErrorBody" }
        },
        "example": {
          "error": {
            "code": "INVALID_TEMPLATE",
            "message": "Template JSON is malformed or missing required fields",
            "details": null
          }
        }
      },
      "ErrorBody": {
        "type": "object",
        "description": "Error details",
        "required": ["code", "message"],
        "properties": {
          "code": { "type": "string", "description": "Error code", "example": "INVALID_TEMPLATE" },
          "message": { "type": "string", "description": "Human-readable error message", "example": "Template JSON is malformed or missing required fields" },
          "details": { "description": "Additional error details (optional)" }
        }
      }
    }
  }
}
